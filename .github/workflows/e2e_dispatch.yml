name: E2E Dispatch
on:
  workflow_dispatch:
    inputs:
      target:
        description: "both | eqp002 | eqp003 | admin"
        required: true
        default: "both"

jobs:
  e2e:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install -r requirements.txt
          npm ci
          npx playwright install --with-deps

      - name: Build tasks.json (robust)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference='Stop'
          $csv = $null
          if (Test-Path .\data\tasks_template.csv) { $csv = '.\data\tasks_template.csv' }
          elseif (Test-Path .\tests\tasks_template.csv) { $csv = '.\tests\tasks_template.csv' }
          else { throw "tasks_template.csv yok." }
          node .\scripts\build-tasks.js $csv .\tests\tasks.json 2>$null
          if (!(Test-Path .\tests\tasks.json) -and (Test-Path .\tasks.json)) { Copy-Item .\tasks.json .\tests\tasks.json -Force }
          $j = Get-Content .\tests\tasks.json -Raw | ConvertFrom-Json
          if (-not ($j -is [System.Collections.IEnumerable]) -or @($j).Count -le 0) { throw "tests\tasks.json boş!" }
          Write-Host "OK tasks.json" 

      - name: Start Django (bg)
        shell: pwsh
        run: |
          $env:BASE_URL="http://127.0.0.1:8010"
          $env:ADMIN_USER="admin"
          $env:ADMIN_PASS="admin"
          python manage.py migrate
          Start-Process -FilePath python -ArgumentList "manage.py","runserver","0.0.0.0:8010" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Run tests (files only, ignore tasks.spec.js)
        shell: pwsh
        run: |
          $t = "${{ github.event.inputs.target }}"
          switch ($t) {
            'eqp002' { $files = @('EQP-002.spec.js') }
            'eqp003' { $files = @('EQP-003.spec.js') }
            'admin'  { $files = @('admin-dashboard.spec.js') }
            default  { $files = @('admin-dashboard.spec.js','EQP-002.spec.js','EQP-003.spec.js') }
          }
          # Playwright argümanları REGEX'tir; çıplak dosya adı zaten eşleşir.
          # tasks.spec.js'in potansiyel sorunlarını önlemek için --test-ignore ekliyoruz:
          npx playwright test @files --project=chromium --reporter "line,html" --test-ignore "tasks\.spec\.js"

      - name: Upload playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

name: E2E Dispatch
on:
  workflow_dispatch:
    inputs:
      target:
        description: "eqp002 | eqp003 | admin | both"
        required: true
        default: "both"

jobs:
  e2e:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install -r requirements.txt
          npm ci
          npx playwright install --with-deps

      - name: Build tasks.json
        shell: pwsh
        run: |
          if (Test-Path .\data\tasks_template.csv) {
            node scripts/build-tasks.js data/tasks_template.csv tests/tasks.json
          } elseif (Test-Path .\tests\tasks_template.csv) {
            node scripts/build-tasks.js tests/tasks_template.csv tests/tasks.json
          } else {
            Write-Host "No CSV found, skipping tasks build."
          }

      - name: Start Django (bg)
        shell: pwsh
        run: |
          $env:BASE_URL="http://127.0.0.1:8010"
          $env:ADMIN_USER="admin"
          $env:ADMIN_PASS="admin"
          python manage.py migrate
          Start-Process -FilePath python -ArgumentList "manage.py","runserver","0.0.0.0:8010" -WindowStyle Hidden
          Start-Sleep -Seconds 5

      - name: Load helpers
        shell: pwsh
        run: |
          . .\tools\pw_helpers.ps1

      - name: Run selected tests
        shell: pwsh
        run: |
          switch ("${{ github.event.inputs.target }}") {
            'eqp002' { eqp002; break }
            'eqp003' { eqp003; break }
            'admin'  { adminOnly; break }
            default  { eqpBoth; break }
          }

      - name: Upload playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
